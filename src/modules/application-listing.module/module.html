{# Module styles #}

<style>
  {% scope_css %}
    @media (min-width: 767px) {
      .card {
        width: calc({{(100 / module.columns)}}% - 0.7rem);
      }
    }
  {% end_scope_css %}
</style>

{# Module data #}

{% if !is_in_editor %}
  {% set contact = data_query.data.CRM.contact %}
  {% set applications = contact.associations.p_job_application_collection__job_application_to_contact.items %}
{% else %}

  {# Example data used in the editor #}

  {% set applications = [
      {
        application_status: 'Applied',
        associations: {
          p_role_collection__role_to_job_application: {
            items: [
              {
                department: 'Sales',
                location: 'Aventura, FL',
                associations: {
                  company_collection__role_to_company: {
                    items: [
                      {
                        name: 'Tesla'
                      }
                    ]
                  }
                }
              }
            ]
          }
        },
        job_title: 'Store Leader'
      },
      {
        application_status: 'Applied',
        associations: {
          p_role_collection__role_to_job_application: {
            items: [
              {
                department: 'Operations',
                location: 'Cambridge, MA',
                associations: {
                  company_collection__role_to_company: {
                    items: [
                      {
                        name: 'HubSpot'
                      }
                    ]
                  }
                }
              }
            ]
          }
        },
        job_title: 'Sales Operation Specialist'
      }
    ]
  %}

{% endif %}

  {# Application listing #}

  <section class="card-listing">

    {# Heading #}

    <h1 class="card-listing__heading">{{ applications|length }} {{ module.heading }}</h1>

    {# Application cards #}

    {% for application in applications %}

      {% set role = application.associations.p_role_collection__role_to_job_application.items|first %}
      {% set company = role.associations.company_collection__role_to_company.items|first %}

      <section class="card">
        <h2 class="card__heading">{{ application.job_title }}</h2>
        <h3 class="card__subheading">{{ company.name }}</h3>

        {# Application card details #}

        {% for card_detail in module.application_card.details %}

          {# Sets values for detail based on field choice #}

          {% if card_detail.detail == 'date_submitted' %}
            {% set detail = company.name %}
          {% elif card_detail.detail == 'department' %}
            {% set detail = role.department|capitalize %}
          {% elif card_detail.detail == 'location' %}
            {% set detail = role.location %}
          {% elif card_detail.detail == 'status' %}
            {% set detail = application.application_status|capitalize %}
          {% endif %}

          <span class="card__item">
            <span class="card__item-label">{{ card_detail.detail_label }}</span>
            <span class="card__item-detail"> {{ detail }}</span>
          </span>

        {% endfor %}

        <a class="card__button button" href="/application-details?applicationId={{ application._metadata.id }}">{{ module.application_card.button_text }}</a>
      </section>

    {% endfor %}

  </section>